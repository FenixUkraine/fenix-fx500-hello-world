# Fenix FX500 Hello World

Репозиторій для тестування публічних компонентів системи Fenix Auto FX500.

**Увага розробникам, хто долучений до розробки Fenix Auto!**  
Не публікуйте тут нічого, що має відношення до системи Fenix Auto FX500, будь-які SSL-сертифікати, адреси серверів, тощо.

Цей репозиторій створений виключно для тестування збірки окремих компонентів, які є публічно-доступними: драйвери, модулі, бібліотеки, та інше. Тестування збірки в Zephyr RTOS, тощо.

## Зміст
- [Вступ](#вступ)
- [Встановлення інструментів та залежностей](#встановлення-інструментів-та-залежностей)
- [Підготовка до збірки](#підготовка-до-збірки)
- [Збірка проєкта](#збірка-проєкта)
- [Внесок в проєкт](#внесок-в-проєкт)
- [Ліцензія](#ліцензія)

## Вступ
Цей репозиторій створено для опису процесу встановлення оточення, компіляторів, бібліотек, а також для надання інструкцій по збірці, прошивці, та інше.

## Встановлення інструментів та залежностей

### Встановлення Zephyr SDK
Встановіть базові речі, в залежності від вашої операційної системи:

- CMake
- Python
- Device compiler

Дивіться розділ Install dependencies [тут](https://docs.zephyrproject.org/latest/develop/getting_started/index.html).

Сам Zephyr встановлювати не треба, він буде встановлений в процесі підготовки до збірки цього проєкту.

*від Денис:*  
Я тут буду залишати команди для MacOS, для інших систем будуть трохи відрізнятись.

## Підготовка до збірки

Склонуйте цей репозиторій.

```bash
git clone git@github.com:FenixUkraine/fenix-fx500-hello-world.git
cd fenix-fx500-hello-world
```

Бажано створювати віртуальне оточення `venv`, активувати, встановити `west`, дивіться [інструкцію](https://docs.zephyrproject.org/latest/develop/getting_started/index.html).

```bash
python3 -m venv .venv
source .venv/bin/activate
python3 -m pip install west
west init -l app
west update -o=--depth=1 -n
west packages pip --install
west sdk install
```

*Примітка:*  
Після `python3 -m pip install west`, якщо `west` ще встановлений глобально, то при виконанні `west ...` виконується глобальний, а не з `.venv`. Доводиться або виконувати через `./.venv/bin/west ...`, або через `python3 -m west ...`.

## Збірка проєкта

Виконайте:

```bash
west build app --build-dir build-app -b fxa500_02
```

Прошити плату можна командою:

```bash
west build app --build-dir build-app -b fxa500_02 -t flash
```

Можна правити або безпосередньо файли device tree, або краший варіант - використати оверлеї.

Ось як приклад, як можна збирати прошивку без датчика удару:

```
west build app --build-dir build-app -b fxa500_02 -p -- -DEXTRA_DTC_OVERLAY_FILE=no-shock-sensor.overlay
```

### До речі. Під Windows та Linux, можна тестувати щось через натівну компіляцію

```bash
west build app --build-dir build-app-native_posix -b native_posix
```

Ще є симулятор, дивіться документацію до Zephyr.

```bash
west build app --build-dir build-app-qemu -b qemu_cortex_m0
```

Можна на іншій платі щось відлагоджувати. Як приклад, додано `hal_wch`, і можна щось тестувати на (мабуть) найдешевшому (біля $0.1) на планеті мікроконтроллері:

```bash
west build app --build-dir build-app-ch32v003evt -b ch32v003evt
```

## Внесок в проєкт

Ми вітаємо ваш внесок! Будь ласка, дотримуйтесь наступних кроків для внесення вашого внеску:

1. Форкніть цей репозиторій.
2. Створіть нову гілку (`git checkout -b feature-branch`).
3. Внесіть ваші зміни і закомітьте їх (`git commit -am 'Додано нову функцію'`).
4. Відправте ваші зміни в форк (`git push origin feature-branch`).
5. Створіть новий Pull Request.

## Інструкції та поради по роботі з репозиторіями компонентів.

Проєкт має модульну архітектуру. Може мати доволі велику кількість модулів, і зазвичай,
зміни будуть вноситись в модулі, а не в основний проєкт. Тут будуть нагадування, як
зручніше працювати з субмодулями.

Прості зміни можна вносити в відповідних репозиторіях самих модулів, пушити зміни, та
вже в основному проєкті виконувати:

```shell
west update -o=--depth=1 -n
```

Це не завжди зручно, коли ведеться активне відлагодження. В такому випадку буває зручно вносити
правки в локальних копіях модулів. Тут треба зауважити особливість роботи механізмів `west`.
Модулі імпортуються в режимі `detached HEAD`. Тому якшо треба запушити зміни в модулі то
треба це робити, наприклад, так:

- Перейти в каталог з модулем. Або відкрити каталог модуля в десктопном Git.
- Створити нову гілку.
- Закомітити зміни.
- Запушити гілку.
- Створити pull request на github.
- Прийняти pull request на gihub.
- Оновити проєкт через `west`

```shell
cd modules/shock-sensor-driver
git status
git checkout -b feature/my-changes-1
git add .
git commit -m "Опис змін."
git push -u baden feature/my-changes-1
```

Тут треба ще нагадади шо можливо на сервері вже були зміни в модулі, і перед
створенням коміта, треба оновити локальний стан гілки `main` і позбавитись конфліктів.

```shell
cd modules/shock-sensor-driver
git status
git checkout -b feature/my-changes-1
git add .
git commit -m "Опис змін."
git checkout main
git pull origin main
git checkout feature/my-changes-1
git rebase main
```

Пофіксити конфлікти якшо вони є.

```shell
git status  # Показує файли з конфліктами (позначені червоним)
```

Приклад конфлікту в файлі

```diff
<<<<<<< HEAD
// Зміни з main
public void calculate() {
    int x = 10;
}
=======
// Ваші зміни з feature/login
public void calculate() {
    int x = 20;
}
>>>>>>> 1234567... Commit message
```

Правимо як нам треба. Плагін в VSCode, або декстопний клієнт Git спрощує цю процедуру.

- Помічаємо файл як вирішений
- Продовжуємо rebase

```shell
git add <file>
git rebase --continue
```

Абo, якшо, наприклад, файл треба видалити:

```shell
git rm <file>
git rebase --continue
```

Коли всі конфлікти вирішени, можна запушити коміт. Він буде від актуальної гілки `main`.

```shell
git push -u baden feature/my-changes-1
```

Спробуйте `git rebase -i main` у інтерактивному режимі.
Можливо в вашій десктопній версії Git є зручний механізм для rebase.
